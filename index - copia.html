<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIL - Dashboard de Indicadores | GADPM</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #1f8fff;
            --secondary-blue: #00bfff;
            --light-blue: #89cfeb;
            --accent-blue: #add8e6;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #495057;
            --white: #ffffff;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --shadow-hover: 0 4px 20px rgba(0,0,0,0.15);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--light-gray) 0%, var(--medium-gray) 100%);
            color: var(--dark-gray);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Notification System */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }

        .notification {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-hover);
            margin-bottom: 10px;
            padding: 1rem;
            border-left: 4px solid var(--primary-blue);
            animation: slideIn 0.3s ease-out;
            position: relative;
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notification-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--dark-gray);
            opacity: 0.7;
        }

        .notification-close:hover {
            opacity: 1;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: var(--white);
            padding: 1.5rem 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--primary-blue);
            font-size: 1.2rem;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin: 0;
        }

        .header-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--medium-gray);
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Filters Section */
        .filters-section {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .filters-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            color: var(--primary-blue);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-select, .filter-input {
            padding: 0.75rem 1rem;
            border: 2px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--white);
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--light-blue);
            box-shadow: 0 0 0 3px rgba(74, 144, 194, 0.2);
        }

        .search-container {
            grid-column: 1 / -1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            transition: var(--transition);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--dark-gray);
            font-size: 1.2rem;
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue), var(--light-blue));
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.2rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 0.5rem;
        }

        .stat-description {
            font-size: 0.9rem;
            color: var(--dark-gray);
            opacity: 0.8;
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
        }

        .chart-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            color: var(--primary-blue);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        .chart-error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--danger);
            display: none;
        }

        /* Table Section */
        .table-section {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .table-header {
            padding: 2rem 2rem 1rem;
            border-bottom: 2px solid var(--medium-gray);
        }

        .table-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-blue);
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .table-subtitle {
            color: var(--dark-gray);
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .indicators-table {
            width: 100%;
            border-collapse: collapse;
        }

        .indicators-table th {
            background: var(--light-gray);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--medium-gray);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .indicators-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--medium-gray);
            font-size: 0.95rem;
        }

        .indicators-table tr:hover {
            background: var(--light-gray);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-primary {
            background: var(--accent-blue);
            color: var(--primary-blue);
        }

        .badge-success {
            background: rgba(40, 167, 69, 0.2);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(255, 193, 7, 0.2);
            color: #856404;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--dark-gray);
            opacity: 0.7;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--medium-gray);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header-content {
                padding: 0 1rem;
                flex-direction: column;
                text-align: center;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-section {
                grid-template-columns: 1fr;
            }

            .filters-section, .chart-card, .table-header {
                padding: 1.5rem;
            }

            .stat-card {
                padding: 1.5rem;
            }

            .notification-container {
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Loading States for Cards */
        .loading-card {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }

        .loading-card::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            margin: -15px 0 0 -15px;
            border: 3px solid var(--medium-gray);
            border-top: 3px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">SIL</div>
                <div>
                    <h1>Sistema de Información Local</h1>
                    <div class="header-subtitle">Dashboard de Indicadores - GADPM</div>
                </div>
            </div>
            <div style="font-size: 0.9rem; opacity: 0.9;">
                Provincia de Manabí
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <main class="container">
        <!-- Filters Section -->
        <section class="filters-section" role="search" aria-labelledby="filters-title">
            <div class="filters-header">
                <i class="fas fa-search"></i>
                <span id="filters-title">Filtros de Búsqueda</span>
            </div>
            
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label" for="component-filter">Componente</label>
                    <select class="filter-select" id="component-filter" aria-describedby="component-help">
                        <option value="">Todos los componentes</option>
                    </select>
                    <div id="component-help" class="sr-only">Selecciona un componente para filtrar los indicadores</div>
                </div>

                <div class="filter-group">
                    <label class="filter-label" for="direction-filter">Dirección</label>
                    <select class="filter-select" id="direction-filter" aria-describedby="direction-help">
                        <option value="">Todas las direcciones</option>
                    </select>
                    <div id="direction-help" class="sr-only">Selecciona una dirección para filtrar los indicadores</div>
                </div>

                <div class="filter-group">
                    <label class="filter-label" for="theme-filter">Temática</label>
                    <select class="filter-select" id="theme-filter" aria-describedby="theme-help">
                        <option value="">Todas las temáticas</option>
                    </select>
                    <div id="theme-help" class="sr-only">Selecciona una temática para filtrar los indicadores</div>
                </div>

                <div class="filter-group">
                    <label class="filter-label" for="sector-filter">Sector Estadístico</label>
                    <select class="filter-select" id="sector-filter" aria-describedby="sector-help">
                        <option value="">Todos los sectores</option>
                    </select>
                    <div id="sector-help" class="sr-only">Selecciona un sector estadístico para filtrar los indicadores</div>
                </div>

                <div class="search-container">
                    <label class="filter-label" for="search-input">Buscar Indicador</label>
                    <div style="position: relative;">
                        <i class="fas fa-search search-icon"></i>
                        <input 
                            type="text" 
                            class="search-input" 
                            id="search-input"
                            placeholder="Escribe el nombre del indicador que buscas..."
                            aria-describedby="search-help"
                        >
                    </div>
                    <div id="search-help" class="sr-only">Escribe para buscar indicadores por nombre</div>
                </div>
            </div>
        </section>

        <!-- Statistics Cards -->
        <section class="stats-grid" role="region" aria-labelledby="stats-title">
            <h2 id="stats-title" class="sr-only">Estadísticas Generales</h2>
            
            <div class="stat-card" id="totalIndicatorsCard">
                <div class="stat-header">
                    <div class="stat-title">Total de Indicadores</div>
                    <div class="stat-icon"><i class="fas fa-chart-bar"></i></div>
                </div>
                <div class="stat-value">0</div>
                <div class="stat-description">Indicadores definidos en el PDOT provincial</div>
            </div>

            <div class="stat-card" id="registrosCard">
                <div class="stat-header">
                    <div class="stat-title">Registros Administrativos</div>
                    <div class="stat-icon"><i class="fas fa-clipboard-list"></i></div>
                </div>
                <div class="stat-value">0</div>
                <div class="stat-description">Fuentes de datos administrativos disponibles</div>
            </div>

            <div class="stat-card" id="componentsCard">
                <div class="stat-header">
                    <div class="stat-title">Componentes Temáticos</div>
                    <div class="stat-icon"><i class="fas fa-building"></i></div>
                </div>
                <div class="stat-value">0</div>
                <div class="stat-description">Áreas de desarrollo territorial</div>
            </div>

            <div class="stat-card" id="updateCard">
                <div class="stat-header">
                    <div class="stat-title">Última Actualización</div>
                    <div class="stat-icon"><i class="fas fa-sync-alt"></i></div>
                </div>
                <div class="stat-value">Mayo</div>
                <div class="stat-description">2025 - Datos actualizados mensualmente</div>
            </div>
        </section>

        <!-- Charts Section -->
        <section class="charts-section" role="region" aria-labelledby="charts-title">
            <h2 id="charts-title" class="sr-only">Visualizaciones de Datos</h2>
            
            <div class="chart-card" id="componentChartCard">
                <div class="chart-header">
                    <i class="fas fa-chart-pie"></i>
                    <span>Indicadores por Componente</span>
                </div>
                <div class="chart-container">
                    <canvas id="componentChart" aria-label="Gráfico de indicadores por componente"></canvas>
                    <div class="chart-loading" id="componentChartLoading">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="chart-error" id="componentChartError">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error al cargar el gráfico</p>
                    </div>
                </div>
            </div>

            <div class="chart-card" id="periodicityChartCard">
                <div class="chart-header">
                    <i class="fas fa-clock"></i>
                    <span>Distribución por Periodicidad</span>
                </div>
                <div class="chart-container">
                    <canvas id="periodicityChart" aria-label="Gráfico de distribución por periodicidad"></canvas>
                    <div class="chart-loading" id="periodicityChartLoading">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="chart-error" id="periodicityChartError">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error al cargar el gráfico</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Table Section -->
        <section class="table-section" role="region" aria-labelledby="table-title">
            <div class="table-header">
                <div class="table-title">
                    <i class="fas fa-table"></i>
                    <span id="table-title">Listado Detallado de Indicadores</span>
                </div>
                <div class="table-subtitle">
                    Explora todos los indicadores disponibles con información detallada
                </div>
            </div>
            
            <div class="table-container">
                <table class="indicators-table" role="table" aria-labelledby="table-title">
                    <thead>
                        <tr>
                            <th scope="col">Nombre del Indicador</th>
                            <th scope="col">Componente</th>
                            <th scope="col">Dirección</th>
                            <th scope="col">Sector Estadístico</th>
                            <th scope="col">ID RA</th>
                            <th scope="col">Periodicidad</th>
                            <th scope="col">Dashboard</th>
                        </tr>
                    </thead>
                    <tbody id="indicatorsTableBody">
                        <tr>
                            <td colspan="7" class="empty-state">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Cargando indicadores...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        // Configuración centralizada
        const CONFIG = {
            CSV_PATH: 'data/indicators.csv',
            CHART_COLORS: ['#1f8fff', '#00bfff', '#89cfeb', '#add8e6', '#b1e0e7', '#b1e0e7'],
            PERIODICITIES: ['Mensual', 'Trimestral', 'Semestral', 'Anual'],
            DEBOUNCE_DELAY: 300,
            REQUIRED_COLUMNS: ['Componente', 'Direccion', 'SectorE'],
            FALLBACK_VALUES: {
                indicatorName: 'Sin nombre',
                component: 'Sin categorizar',
                direction: 'No especificado',
                sector: 'No especificado',
                lastUpdate: 'No disponible'
            }
        };

        // Estado global de la aplicación
        let appState = {
            data: [],
            filteredData: [],
            isLoading: false,
            error: null,
            charts: {
                component: null,
                periodicity: null
            }
        };

        // Sistema de notificaciones
        class NotificationManager {
            static show(message, type = 'info', duration = 5000) {
                const container = document.getElementById('notificationContainer');
                if (!container) return;

                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                const icon = this.getIcon(type);
                notification.innerHTML = `
                    <div class="notification-content">
                        <i class="${icon}"></i>
                        <span>${message}</span>
                    </div>
                    <button class="notification-close" aria-label="Cerrar notificación">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                container.appendChild(notification);

                // Auto-remove
                const autoRemove = setTimeout(() => this.remove(notification), duration);

                // Manual remove
                const closeBtn = notification.querySelector('.notification-close');
                closeBtn.addEventListener('click', () => {
                    clearTimeout(autoRemove);
                    this.remove(notification);
                });

                return notification;
            }

            static getIcon(type) {
                const icons = {
                    'success': 'fas fa-check-circle',
                    'error': 'fas fa-exclamation-circle',
                    'warning': 'fas fa-exclamation-triangle',
                    'info': 'fas fa-info-circle'
                };
                return icons[type] || icons.info;
            }

            static remove(notification) {
                if (notification && notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease-out forwards';
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }
            }
        }

        // Utilidades para DOM seguro
        function safeQuerySelector(selector, context = document) {
            const element = context.querySelector(selector);
            if (!element) {
                console.warn(`Elemento '${selector}' no encontrado`);
            }
            return element;
        }

        function safeQuerySelectorAll(selector, context = document) {
            const elements = context.querySelectorAll(selector);
            if (elements.length === 0) {
                console.warn(`No se encontraron elementos con selector '${selector}'`);
            }
            return Array.from(elements);
        }

        // Función mejorada para obtener el nombre del indicador
        function getIndicatorName(indicator) {
            return indicator.Nombre_Indicador || 
                   indicator['Descripción IN'] || 
                   indicator.N || 
                   CONFIG.FALLBACK_VALUES.indicatorName;
        }

        // Parser CSV robusto con validación completa
        function parseCSVRobust(csv) {
            console.log("🔄 Iniciando parseo de CSV...");
            
            try {
                if (!csv || typeof csv !== 'string') {
                    throw new Error('El contenido CSV está vacío o no es válido');
                }

                // Limpiar BOM y dividir líneas
                const lines = csv.replace(/^\uFEFF/, '').split(/\r?\n/)
                    .filter(line => line.trim() !== '');

                if (lines.length < 2) {
                    throw new Error('El CSV debe tener al menos una fila de encabezados y una de datos');
                }

                // Procesar encabezados
                const headers = lines[0].split(';').map(h => h.trim().replace(/"/g, ''));
                console.log("📋 Encabezados encontrados:", headers);

                // Validar columnas requeridas
                const missingColumns = CONFIG.REQUIRED_COLUMNS.filter(col => !headers.includes(col));
                if (missingColumns.length > 0) {
                    console.warn(`⚠️ Columnas faltantes: ${missingColumns.join(', ')}`);
                    NotificationManager.show(
                        `Algunas columnas esperadas no están presentes: ${missingColumns.join(', ')}`,
                        'warning'
                    );
                }

                // Procesar datos
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    try {
                        const values = lines[i].split(';').map(v => v.trim().replace(/"/g, ''));
                        const obj = {};
                        
                        headers.forEach((header, index) => {
                            obj[header] = values[index] || '';
                        });

                        // Validar que tenga al menos un identificador
                        if (getIndicatorName(obj) !== CONFIG.FALLBACK_VALUES.indicatorName) {
                            data.push(obj);
                        }
                    } catch (error) {
                        console.error(`❌ Error procesando fila ${i + 1}:`, error);
                    }
                }

                console.log(`✅ CSV parseado exitosamente. ${data.length} registros válidos`);
                return data;

            } catch (error) {
                console.error('💥 Error crítico en parseCSV:', error);
                NotificationManager.show(
                    `Error al procesar el archivo CSV: ${error.message}`,
                    'error'
                );
                return [];
            }
        }

        // Gestión de estado de carga
        function setLoadingState(isLoading) {
            appState.isLoading = isLoading;
            const overlay = document.getElementById('loadingOverlay');
            
            if (overlay) {
                overlay.style.display = isLoading ? 'flex' : 'none';
            }

            // Aplicar estado de carga a las tarjetas
            const cards = safeQuerySelectorAll('.stat-card, .chart-card');
            cards.forEach(card => {
                card.classList.toggle('loading-card', isLoading);
            });
        }

        // Función para poblar los filtros dinámicamente
        function populateFilters(data) {
            console.log("🎛️ Poblando filtros...");
            
            const componentsSet = new Set();
            const directionsSet = new Set();
            const sectorsSet = new Set();

            data.forEach(item => {
                if (item.Componente && item.Componente.trim()) {
                    componentsSet.add(item.Componente.trim());
                }
                if (item.Direccion && item.Direccion.trim()) {
                    directionsSet.add(item.Direccion.trim());
                }
                if (item.SectorE && item.SectorE.trim()) {
                    sectorsSet.add(item.SectorE.trim());
                }
            });

            // Helper para rellenar un select de forma segura
            function fillSelect(selectId, values, defaultText) {
                const selectElement = safeQuerySelector(`#${selectId}`);
                if (!selectElement) return;

                selectElement.innerHTML = `<option value="">${defaultText}</option>`;
                Array.from(values).sort().forEach(value => {
                    if (value && value.trim()) {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        selectElement.appendChild(option);
                    }
                });
            }

            fillSelect('component-filter', componentsSet, 'Todos los componentes');
            fillSelect('direction-filter', directionsSet, 'Todas las direcciones');
            fillSelect('sector-filter', sectorsSet, 'Todos los sectores');

            console.log(`✅ Filtros poblados: ${componentsSet.size} componentes, ${directionsSet.size} direcciones, ${sectorsSet.size} sectores`);
        }

        // Función para actualizar las tarjetas de estadísticas
        function updateStatsCards(data) {
            const stats = {
                total: data.length,
                uniqueRAs: new Set(data.map(item => item.Id_RA).filter(Boolean)).size,
                uniqueComponents: new Set(data.map(item => item.Componente).filter(Boolean)).size
            };

            // Actualizar cada tarjeta de forma segura
            const totalElement = safeQuerySelector('#totalIndicatorsCard .stat-value');
            if (totalElement) totalElement.textContent = stats.total;

            const rasElement = safeQuerySelector('#registrosCard .stat-value');
            if (rasElement) rasElement.textContent = stats.uniqueRAs;

            const componentsElement = safeQuerySelector('#componentsCard .stat-value');
            if (componentsElement) componentsElement.textContent = stats.uniqueComponents;
        }

        // Función para actualizar la tabla
        function updateTable(data) {
            const tableBody = safeQuerySelector('#indicatorsTableBody');
            if (!tableBody) return;

            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-search"></i>
                            <p>No se encontraron indicadores que coincidan con los filtros aplicados</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = '';

            data.forEach((indicator, index) => {
                const row = tableBody.insertRow();
                
                // Nombre del indicador
                const nameCell = row.insertCell();
                nameCell.innerHTML = `<strong>${getIndicatorName(indicator)}</strong>`;

                // Componente
                const componentCell = row.insertCell();
                const component = indicator.Componente || CONFIG.FALLBACK_VALUES.component;
                componentCell.innerHTML = `<span class="badge badge-primary">${component}</span>`;

                // Dirección
                const directionCell = row.insertCell();
                directionCell.textContent = indicator.Direccion?.trim() || CONFIG.FALLBACK_VALUES.direction;

                // Sector
                const sectorCell = row.insertCell();
                sectorCell.textContent = indicator.SectorE?.trim() || CONFIG.FALLBACK_VALUES.sector;

                // ID RA
                const idCell = row.insertCell();
                idCell.textContent = indicator.Id_RA || '-';

                // Periodicidad (dummy)
                const periodicityCell = row.insertCell();
                const periodicity = CONFIG.PERIODICITIES[index % CONFIG.PERIODICITIES.length];
                periodicityCell.innerHTML = `<span class="badge badge-success">${periodicity}</span>`;
            });
        }

        // Función para actualizar todo el dashboard
        function updateDashboard(data) {
            console.log(`📊 Actualizando dashboard con ${data.length} registros`);
            updateStatsCards(data);
            updateTable(data);
        }

        // Inicialización de gráficos con manejo de errores
        function initializeCharts() {
            console.log("📈 Inicializando gráficos...");
            
            try {
                initializeComponentChart();
                initializePeriodicityChart();
                console.log("✅ Gráficos inicializados exitosamente");
            } catch (error) {
                console.error("❌ Error inicializando gráficos:", error);
                NotificationManager.show('Error al crear los gráficos de visualización', 'error');
            }
        }

        function initializeComponentChart() {
            const canvas = safeQuerySelector('#componentChart');
            if (!canvas) return;

            // Destruir gráfico anterior si existe
            if (appState.charts.component) {
                appState.charts.component.destroy();
            }

            // Calcular datos del gráfico
            const componentCounts = {};
            appState.data.forEach(item => {
                const component = item.Componente || CONFIG.FALLBACK_VALUES.component;
                componentCounts[component] = (componentCounts[component] || 0) + 1;
            });

            const labels = Object.keys(componentCounts);
            const data = Object.values(componentCounts);

            if (labels.length === 0) {
                console.warn("⚠️ No hay datos para el gráfico de componentes");
                return;
            }

            const ctx = canvas.getContext('2d');
            appState.charts.component = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: labels.map((_, i) => CONFIG.CHART_COLORS[i % CONFIG.CHART_COLORS.length]),
                        borderWidth: 0,
                        hoverBorderWidth: 2,
                        hoverBorderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed} indicadores`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function initializePeriodicityChart() {
            const canvas = safeQuerySelector('#periodicityChart');
            if (!canvas) return;

            // Destruir gráfico anterior si existe
            if (appState.charts.periodicity) {
                appState.charts.periodicity.destroy();
            }

            const ctx = canvas.getContext('2d');
            appState.charts.periodicity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: CONFIG.PERIODICITIES,
                    datasets: [{
                        label: 'Número de Indicadores',
                        data: [8, 15, 12, 41], // Datos de ejemplo
                        backgroundColor: 'rgba(31, 143, 255, 0.8)',
                        borderColor: '#1f8fff',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} indicadores`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 5 }
                        }
                    }
                }
            });
        }

        // Sistema de filtros mejorado
        function setupFilters() {
            console.log("🎛️ Configurando sistema de filtros...");
            
            const filterElements = safeQuerySelectorAll('.filter-select, .filter-input');
            
            filterElements.forEach(element => {
                if (element.type === 'text') {
                    element.addEventListener('input', debounce(filterData, CONFIG.DEBOUNCE_DELAY));
                } else {
                    element.addEventListener('change', filterData);
                }
            });

            console.log(`✅ ${filterElements.length} filtros configurados`);
        }

        function filterData() {
            console.log("🔍 Aplicando filtros...");
            
            const filters = {
                component: safeQuerySelector('#component-filter')?.value || '',
                direction: safeQuerySelector('#direction-filter')?.value || '',
                sector: safeQuerySelector('#sector-filter')?.value || '',
                search: safeQuerySelector('#search-input')?.value.toLowerCase() || ''
            };

            appState.filteredData = appState.data.filter(item => {
                const matchesComponent = !filters.component || item.Componente === filters.component;
                const matchesDirection = !filters.direction || item.Direccion?.trim() === filters.direction;
                const matchesSector = !filters.sector || item.SectorE?.trim() === filters.sector;
                
                const indicatorName = getIndicatorName(item).toLowerCase();
                const matchesSearch = !filters.search || indicatorName.includes(filters.search);

                return matchesComponent && matchesDirection && matchesSector && matchesSearch;
            });

            console.log(`🎯 Filtros aplicados: ${appState.filteredData.length} de ${appState.data.length} registros`);
            updateDashboard(appState.filteredData);
        }

        // Utilidad de debounce
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Función principal de carga e inicialización
        async function loadDataAndInitializeDashboard() {
            console.log("🚀 Iniciando carga del dashboard...");
            setLoadingState(true);

            try {
                NotificationManager.show('Cargando datos de indicadores...', 'info', 2000);

                const response = await fetch(CONFIG.CSV_PATH);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
                }

                const csvText = await response.text();
                appState.data = parseCSVRobust(csvText);

                if (appState.data.length === 0) {
                    throw new Error('No se pudieron cargar datos válidos del archivo CSV');
                }

                appState.filteredData = [...appState.data];

                // Inicializar componentes del dashboard
                populateFilters(appState.data);
                updateDashboard(appState.data);
                initializeCharts();
                setupFilters();

                NotificationManager.show(
                    `Dashboard cargado exitosamente con ${appState.data.length} indicadores`,
                    'success'
                );

                console.log("✅ Dashboard inicializado completamente");

            } catch (error) {
                console.error("💥 Error fatal en la carga del dashboard:", error);
                
                NotificationManager.show(
                    `Error al cargar el dashboard: ${error.message}`,
                    'error',
                    10000
                );

                // Mostrar estado de error en la tabla
                const tableBody = safeQuerySelector('#indicatorsTableBody');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
                                <p>Error al cargar los datos: ${error.message}</p>
                                <p style="font-size: 0.8rem; margin-top: 0.5rem;">
                                    Verifica que el archivo 'data/indicators.csv' exista y sea accesible.
                                </p>
                            </td>
                        </tr>
                    `;
                }
            } finally {
                setLoadingState(false);
            }
        }

        // Manejo de eventos de accesibilidad
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                document.body.classList.add('keyboard-navigation');
            }
        });

        document.addEventListener('mousedown', function() {
            document.body.classList.remove('keyboard-navigation');
        });

        // Inicialización cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', loadDataAndInitializeDashboard);

        // Manejo de errores globales
        window.addEventListener('error', function(event) {
            console.error('Error global capturado:', event.error);
            NotificationManager.show(
                'Se produjo un error inesperado. Por favor, recarga la página.',
                'error'
            );
        });

        // Agregar animación de slide out para notificaciones
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>